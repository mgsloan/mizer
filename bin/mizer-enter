#!/usr/bin/env bash
set -e

script_dir=$(dirname "$0")

if [ -z "$GIT_MIZER_TARGET" ]
then
  if [ -z "$1" ]
  then
    echo "Expected first cli argument to be git-mizer target dir"
    exit 1
  else
    export GIT_MIZER_TARGET=$PWD/$1
  fi
  export GIT_MIZER_BASE=$PWD
  pushd ../ > /dev/null
  export GIT_MIZER_DIR=$PWD/.git-mizer
  popd > /dev/null
  mkdir -p $GIT_MIZER_DIR
else
  # If target is set in environment, then don't expect first arg to be variant.
  set -- "" $@
fi

if [ -z "$2" ]
then
  pushd $GIT_MIZER_DIR  > /dev/null
  raw_created=$(mktemp -d -p . "variantXXX")
  # Trim leading ./
  export GIT_MIZER_VARIANT=${raw_created#$"./"}
  popd > /dev/null
  echo "Entering random git-mizer variant: $GIT_MIZER_VARIANT"
else
  export GIT_MIZER_VARIANT=$2
  echo "Entering git-mizer variant: $GIT_MIZER_VARIANT"
fi

export PS1="[\$GIT_MIZER_TARGET] $PS1"

$script_dir/../tlpi-dist/namespaces/userns_child_exec -m -U -z $script_dir/mizer-mount
